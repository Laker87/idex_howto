# Вступление
Данная инстукция предназначена для настройки полноценного idex на 3D-принтерах [Vostok](https://k3d.tech/vostok), включая режимы дублирования и зеркалирования модели.
На данный момент прошивка Klipper имеет сильно урезанную поддержку работы принтеров с двумя независимыми печатающими головами (idex), а именно: отсутствуют режимы дублирования и зеркалирования, а также независимая настройка парамаметра input shaping для печатающих голов. В связи с этим был создан форк данной прошивки с внесением необходимых изменений для полноценной работы idex режимов.

# Установка прошивки
Установка форка прошивки klipper с полноценной поддержкой idex возможна следующим способом
Используя скрипт [KIAUH](https://github.com/th33xitus/kiauh).
Устанавливаем скрипт и добавляем репозиторий https://github.com/Laker87/klipper согласно [инструкции](https://github.com/th33xitus/kiauh/blob/master/klipper_repos.txt.example). Если ранее уже был установлен официальный репозиторий прошивки klipper, то она будет перезаписана новой версией. 

# Описание конфигурационных файлов
Примеры конфигурационных файлов можно найти [здесь](https://github.com/Laker87/klipper_config). Конфиг разбит на несколько файлов для удобства. 
Основным является файл [printer.cfg](https://github.com/Laker87/klipper_config/blob/master/printer.cfg), он содержит настройки кинематики, моторов осей XYZ, экструдера и нагревателя стола .К нему через include подключены остальные.
Файл [adxl345.cfg](https://github.com/Laker87/klipper_config/blob/master/adxl345.cfg) содержит параметры для компенсации резонансов (input shaper).
Файл [fans.cfg](https://github.com/Laker87/klipper_config/blob/master/fans.cfg) содержит настройки вентиляторов обдува хотендов, модели и электроники, а также макросы для правильной их работы.
Файл [idex.cfg](https://github.com/Laker87/klipper_config/blob/master/idex.cfg) содержит параметры для работы второй головы, а также макросы смены голово Т0, Т1 и макрос calibrate_separation для предварительной калибровки смещения второй головы по оси X.
Файл [macros.cfg](https://github.com/Laker87/klipper_config/blob/master/macros.cfg) содержит все прочие макросы для начала, окончания печати, смены филамента и прочее.
Файл [moonraker.conf](https://github.com/Laker87/klipper_config/blob/master/moonraker.conf) является основным конфигурационным файлом вебсервера [Moonraker](https://github.com/Arksine/moonraker).
Остальные конфигурационные файлы являются не обязательными и их можно исключить закомментировав или удалив соответствующую секцию include в файле [printer.cfg](https://github.com/Laker87/klipper_config/blob/master/printer.cfg).

# Настройка конфигурационных файлов
Всю процедуру настройки конфигов тут описывать не буду, это можно найти в других источниках, в том числе в официальной документации прошивки klipper, опишу лишь особенности настройки для принтеров с двумя печатающими головами.
Настройка второй головы производится в файле [idex.cfg](https://github.com/Laker87/klipper_config/blob/master/idex.cfg). 
Секция [dual_carriage] настраивается аналогично секции [stepper_x] в файле [printer.cfg](https://github.com/Laker87/klipper_config/blob/master/printer.cfg) с отличием в том, что параметр position_endstop должен иметь значение максимальной координаты по оси X, а параметр position_min должен иметь значение минимальной координаты по оси X плюс ширина печатающей головы.
Секция [extruder1] настраивается полностью аналогично секции [extruder].
Макросы PARK_extruder и PARK_extruder1 - это макросы парковки первой и второй головы соответственно.
Макрос Т0 - это макрос активации первой головы. При его вызове производится парковка второй головы, если она активна, и выдавливается небольшое количество пластика для нагнетания давления в сопле. Также в этом макросе задано смещения первой головы относительно второй по оси Y.
Макрос Т1 аналогичен макросу Т0, но для второй головы.
Макрос calibrate_separation служит для грубой настройки смещения второй головы относительно первой по оси X. С помощью этого макроса печатается поочередно одна полоска каждой головой и измеряется смещение полоски, напечатанной второй головой относительно полоски, напечатанной первой головой. Полученное значение добавляется или вычитается (в зависимости от того, в какую сторону смещено) к значениям параметров position_endstop и position_max в секции [dual_carriage]. Также смещение можно менять не путем редактирования параметров position_endstop и position_max, а внесением этого значения в параметр SET_GCODE_OFFSET, находящийся в макросе Т0. Более точную калибровку можно сделать при помощи [данного метода](https://www.thingiverse.com/thing:3873434).
Настройка вентиляторов охлаждения модели и радиатора хотенда производится в файле [fans.cfg](https://github.com/Laker87/klipper_config/blob/master/fans.cfg). Секции [heater_fan hotend] и [heater_fan hotend1] отвечают за вентиляторы обдува радиаторов хотендов, настраиваются стандартным способом. Настройка вентиляторов обдува модели находятся в секциях [fan_generic fan_extruder] и [fan_generic fan_extruder1] для первой и второй головы соответственно. Секция [fan] служит в качестве заглушки для корректной передачи данных об активных вентиляторах в веб интерфейс. В данной секции указывается только любой неиспользуемый пин, к которому ничего не подключено.
Макросы _SET_TOOL_FAN, M106 и M107 необходимы для корректной работы вентиляторов обдува модели.

# Настройка печати
Основными командами для работы с IDEX режимом являются следующие:
SET_DUAL_CARRIAGE CARRIAGE=0 или SET_DUAL_CARRIAGE CARRIAGE=1 - служат для активации первой или второй головы соответственно, не переключают экструдеры.
ACTIVATE_EXTRUDER EXTRUDER=extruder или ACTIVATE_EXTRUDER EXTRUDER=extruder1 - служат для активации экструдера на первой или второй голове соответственно.
SET_DUAL_CARRIAGE_MODE MODE=FULL_CONTROL - классический режим печати одной головой или двухцветная печать.
SET_DUAL_CARRIAGE_MODE MODE=DUPLICATION - режим дублирования модели. При использовании данного режима модель в сласере должна располагаться на левой половине зоны печати. Для печати дожен быть выбран первый экструдер в слайсере.
SET_DUAL_CARRIAGE_MODE MODE=MIRRORED - режим зеркалирования модели. При использовании данного режима модель в слайсере должна располагаться на левой половине зоны печати. Для печати дожен быть выбран первый экструдер в слайсере.
Примеры стартового G-кода для слайсеров можно найти в макросе [START_PRINT](https://github.com/Laker87/klipper_config/blob/e3f69d6449558736dbba6c883a7f1f6ba88989bf/macros.cfg#L2).
Двухцветная печать настраивается обычным спобом в слайсере. 
